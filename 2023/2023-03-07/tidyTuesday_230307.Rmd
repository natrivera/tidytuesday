---
title: "R Notebook"
output: html_notebook
---


```{r}
library(tidyverse)
library(naniar)
library(visdat)
library(gt)
library(gtExtras)
library(glue)
library(svglite)

```



```{r}
numbats <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-03-07/numbats.csv')

```



```{r}
# look at the missing data
vis_dat(numbats )
```


```{r}
# plot the data by year
numbats |>
  group_by(year) |>
  count() |>
  ggplot(aes(x=year , y=n)) +
  geom_point()
```


```{r}
# function that will return html formatted bar chart
bar_chart <- function(value, color = "red", display_value = '&nbsp;'){
  
  vals <- value/3
  
  # html of two spans with bar chart
  glue::glue('<span style=\"display: inline-block; direction: ltr; border-radius: 4px; ' , 
             ' padding-right: 2px; background-color: {color}; color: {color}; width: {vals} \">&nbsp;</span> ' , 
             '<span style=\" font-weight: bold; display: fixed;\">{display_value}</span>')
}
```



```{r}
numbats_agg <- numbats |>
  group_by(dataResourceName) |>
  summarise(Total=n() , yr_na = sum(is.na(year)) , .groups = 'drop')

science_agg <- numbats |>
  group_by(dataResourceName , scientificName) |>
  summarise(n=n() , .groups = 'drop') |>
  pivot_wider(names_from = scientificName , values_from = n)

nrecords <- nrow(numbats)
yr_na <- sum(is.na(numbats$year))
yr_na_percent <-round(  (yr_na / nrecords)*100 , 0)

```


```{r}


tbl <- numbats |>
  mutate(yr = case_when(year < 2005 ~ '<05' , 
                        is.na(year) ~ 'Missing' , 
                        .default = substr(year, 3,4) )
         ) |>
  group_by(dataResourceName  , yr) |>
  summarize(n=n() , .groups = 'drop') |>
  arrange(yr) |>
  pivot_wider(names_from = yr, values_from = n) |>
  left_join(numbats_agg , by=c('dataResourceName')) |>
  left_join(science_agg , by='dataResourceName' ) |>
  mutate(bar_chart = bar_chart(Total, color = "dodgerblue" , display_value = Total ),
        bar_chart = map(bar_chart, ~gt::html(as.character(.x))) ) |>
  arrange(desc(Total)) |>
  select(1,bar_chart , c(20,19) , c(2:18) , c(22,23) ) |>
  mutate(Missing = ifelse(is.na(Missing) , 0 , Missing)) |>
  gt() |>
  #cols_width(dataResourceName ~ px(600) , bar_chart~px(200) )  |>
  tab_spanner( label = md("**YEAR**"), columns = c(3:21) ) |>
  tab_spanner( label = md("**Myrmecobius Fasciatus**"), columns = c(22,23 ) ) |>
  sub_missing(columns = c(3:21), missing_text = "" ) |>
  sub_missing(columns = c(22,23 ), missing_text = "0" ) |>
  cols_label(`Myrmecobius fasciatus` = "-" , `Myrmecobius fasciatus rufus` = "Rufus" ) |>
  data_color(columns = Missing, apply_to = 'fill', 
             colors = scales::col_numeric(
                      palette = c("#C2D3CD", "#34435E"),
                      domain = c(0, 300)
             ) ) |>
  cols_align(align = "left" , columns = c(bar_chart)) |>
  cols_align(align = 'center' , columns = c(3:21) )  |>
  cols_align(align = 'right' , columns = c(1) )  |>
  tab_header(title = md("**Numbat Sightings in Australia**") , 
             subtitle = md('subtitle_txt')) |>
  tab_source_note(
    source_note = md("<b>Data: </b>Atlas of Living Australia (tidytuesday) | <b>Table: </b> Nat Rivera @Itsnatrivera")
  ) 

tbl
```




```{r}
tbl_title <- '**Numbat Sightings in Australia**'
tbl_subtitle <- glue('***{yr_na_percent}%*** ({yr_na}/{nrecords}) of the data is missing timespamps with most comming from Western Australian Museum provider for OZCAM')
tbl_caption <- '<b>Data: </b>Atlas of Living Australia (tidytuesday) | <b>Table: </b> Nat Rivera @Itsnatrivera'

tbl <- numbats |>
  mutate( year = ifelse(year < 2006 , 2005 , year)) |>
  group_by(dataResourceName  ) |>
  summarize(yr_dist=list(year) , .groups = 'drop') |>
  left_join(numbats_agg , by=c('dataResourceName')) |>
  left_join(science_agg , by='dataResourceName' ) |>
  mutate(bar_chart = bar_chart(Total, color = "#F6AE2D" , display_value = Total ),
        bar_chart = map(bar_chart, ~gt::html(as.character(.x))) ) |>
  arrange(desc(Total)) |>
  select(c(1,7,4,2,5,6)) |>
  gt() |>
  gt_plt_dist(yr_dist  , fig_dim = c(5, 70) , fill_color = "#1E96FC") |>
  #gt_plt_bar(column = Total) |>
  tab_spanner( label = md("**Myrmecobius Fasciatus**"), columns = c(5,6) ) |>
  tab_spanner( label = md("**Year**"), columns = c(3,4) ) |>
  cols_align(align = "left" , columns = c(bar_chart)) |>
  cols_align(align = 'right' , columns = c(1) )  |>
  cols_width(yr_dist~px(300)  )  |>
  sub_missing(columns = c(5,6 ), missing_text = "0" ) |>
  cols_label(`Myrmecobius fasciatus` = "-" , 
             `Myrmecobius fasciatus rufus` = "Rufus"  ,
             yr_dist = '<05  06  08  10  12  14  16  18  20  22' , 
             yr_na = 'Missing' , bar_chart = 'Total' , dataResourceName = 'Data Resource') |>
  data_color(columns = yr_na, apply_to = 'fill', 
             colors = scales::col_numeric(
                      palette = c("#C2D3CD", "#34435E"),
                      domain = c(0, 190)
             ) ) |>
  tab_header(title = md(tbl_title) , subtitle = md(tbl_subtitle)) |>
  tab_source_note(source_note = md(tbl_caption) )

  
  #select(1,bar_chart , c(20,19) , c(2:18) , c(22,23) ) |>


tbl
```




